<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>Tiket Kolam Renang</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root { --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745; --light-bg: #f0f8ff; --white-bg: #ffffff; --dark-text: #333; --light-text: #666; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--light-bg); }
        .view { display: none; }
        .view.active { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box; padding: 15px; }
        .container { background: var(--white-bg); padding: 2rem; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 500px; box-sizing: border-box; position: relative; }
        .back-btn { position: absolute; top: 15px; left: 15px; text-decoration: none; font-size: 1.5rem; color: var(--secondary-color); }
        h1 { color: var(--dark-text); text-align: center;}
        h2 { text-align: center; color: var(--dark-text); }
        .button { display: block; width: 100%; padding: 18px; margin: 15px 0; font-size: 1.2em; color: white; border: none; border-radius: 10px; text-decoration: none; cursor: pointer; box-sizing: border-box; }
        .primary { background-color: var(--primary-color); }
        .secondary { background-color: var(--secondary-color); }
        .tertiary { background-color: var(--success-color); }
        label { font-weight: bold; color: var(--light-text); }
        input[type=password], input[type=tel] { width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        .submit-btn { width: 100%; padding: 15px; font-size: 1.2em; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        .ticket-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .controls { display: flex; align-items: center; }
        .qty-btn { width: 40px; height: 40px; font-size: 1.5em; border: 1px solid #ccc; background: #f7f7f7; cursor: pointer; }
        .qty-input { width: 50px; height: 40px; text-align: center; font-size: 1.2em; border: 1px solid #ccc; margin: 0 5px; -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .total { text-align: right; font-size: 1.5em; font-weight: bold; margin-top: 20px; }
        .loader { display: none; text-align: center; }
        .order-id { background-color: #e9ecef; padding: 10px; border-radius: 5px; font-size: 1.2em; font-weight: bold; }
        .whatsapp-btn { display: inline-block; background-color: #25D366; color: white; padding: 15px 25px; margin-top: 20px; border-radius: 5px; text-decoration: none; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.9em;}
        th { background-color: #f2f2f2; }
        .confirm-btn { padding: 5px 10px; background-color: var(--success-color); color: white; border:none; border-radius: 3px; cursor:pointer; }
    </style>
</head>
<body>

    <div id="landingView" class="view active">
        <div class="container" style="text-align:center;">
            <h1>Selamat Datang</h1>
            <p>Silakan pilih menu di bawah ini:</p>
            <a href="#" onclick="showView('formView')" class="button primary">Beli Tiket Online</a>
            <a href="#" onclick="showView('adminLoginView')" class="button secondary">Login Admin</a>
            <a href="#" onclick="showView('scanView')" class="button tertiary">Scan Tiket (Penjaga)</a>
        </div>
    </div>

    <div id="formView" class="view">
        <div class="container">
            <a href="#" onclick="showView('landingView')" class="back-btn">&larr;</a>
            <h2>Pesan Tiket Anda</h2>
            <form id="orderForm">
                <div class="ticket-item"><div><h3>Dewasa</h3><p>Rp 3.000</p></div><div class="controls"><button type="button" class="qty-btn" onclick="updateQty('dewasa', -1)">-</button><input type="number" id="dewasa" class="qty-input" value="0" min="0" oninput="updateTotal()"><button type="button" class="qty-btn" onclick="updateQty('dewasa', 1)">+</button></div></div>
                <div class="ticket-item"><div><h3>Anak-anak</h3><p>Rp 2.000</p></div><div class="controls"><button type="button" class="qty-btn" onclick="updateQty('anak', -1)">-</button><input type="number" id="anak" class="qty-input" value="0" min="0" oninput="updateTotal()"><button type="button" class="qty-btn" onclick="updateQty('anak', 1)">+</button></div></div>
                <div><label for="kontak">Nomor WhatsApp (Opsional)</label><input type="tel" id="kontak" name="kontak"></div>
                <div id="total" class="total">Total: Rp 0</div>
                <button type="submit" id="submitBtn" class="submit-btn primary">Lanjutkan Pembayaran</button>
                <div id="formLoader" class="loader"><p>Memproses pesanan...</p></div>
            </form>
        </div>
    </div>

    <div id="tungguView" class="view">
        <div class="container" style="text-align: center;">
            <a href="#" onclick="showView('formView')" class="back-btn">&larr;</a>
            <h2>Selesaikan Pembayaran Anda</h2>
            <p>Nomor Pesanan Anda adalah:</p>
            <div id="orderIdDisplay" class="order-id"></div>
            <p style="margin-top: 20px;">Silakan lakukan pembayaran melalui QRIS, lalu kirim bukti transfer via WhatsApp.</p>
            <img src="https://storage.googleapis.com/gemini-prod/images/45653c07-28a1-469b-83d3-176a267300c0" alt="QRIS Pembayaran" style="max-width: 250px; margin-top: 10px;">
            <h3>Penting!</h3>
            <p>Sertakan <b>Nomor Pesanan</b> Anda saat mengirim bukti transfer.</p>
            <a id="waLink" href="#" class="whatsapp-btn" target="_blank">Konfirmasi via WhatsApp</a>
        </div>
    </div>

    <div id="adminLoginView" class="view">
        <div class="container" style="max-width: 400px;">
            <a href="#" onclick="showView('landingView')" class="back-btn">&larr;</a>
            <h2>Login Admin</h2>
            <form id="adminLoginForm">
                <label for="password">Password:</label>
                <input type="password" id="password" required>
                <button type="submit" class="submit-btn secondary">Login</button>
            </form>
        </div>
    </div>

    <div id="adminDashboardView" class="view">
        <div class="container">
            <a href="#" onclick="showView('landingView')" class="back-btn">&larr;</a>
            <h2>Dasbor Admin - Pesanan Masuk</h2>
            <button onclick="loadOrders()" style="margin-bottom: 10px;">Refresh Data</button>
            <div id="dashboardLoader" class="loader"><p>Memuat pesanan...</p></div>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Waktu</th><th>Order ID</th><th>Dws</th><th>Ank</th><th>Total</th><th>Aksi</th></tr></thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="scanView" class="view">
        <div class="container">
            <a href="#" onclick="showView('landingView')" class="back-btn">&larr;</a>
            <h2>Halaman Scanner Penjaga</h2>
            <p>Fitur ini akan diaktifkan pada Fase 3.</p>
        </div>
    </div>

    <script>
        // --- LOGIKA UTAMA APLIKASI ---
        const HARGA_DEWASA = <?!= HARGA_DEWASA ?>;
        const HARGA_ANAK = <?!= HARGA_ANAK ?>;
        const NO_WHATSAPP_ADMIN = "<?!= NO_WHATSAPP_ADMIN ?>";

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => view.style.display = 'none');
            document.getElementById(viewId).style.display = 'flex';
        }
        document.addEventListener('DOMContentLoaded', function() { showView('landingView'); });

        // --- Logika Form Pemesanan ---
        function updateQty(item, change) {
            const input = document.getElementById(item);
            let val = parseInt(input.value) + change;
            if (val < 0) val = 0;
            input.value = val;
            updateTotal();
        }
        function updateTotal() {
            const dewasa = parseInt(document.getElementById('dewasa').value) || 0;
            const anak = parseInt(document.getElementById('anak').value) || 0;
            const total = (dewasa * HARGA_DEWASA) + (anak * HARGA_ANAK);
            document.getElementById('total').innerText = 'Total: Rp ' + total.toLocaleString('id-ID');
        }
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('formLoader').style.display = 'block';
            const formData = { dewasa: document.getElementById('dewasa').value, anak: document.getElementById('anak').value, kontak: document.getElementById('kontak').value };
            google.script.run.withSuccessHandler(onOrderSuccess).withFailureHandler(onFailure).processOrder(formData);
        });
        function onOrderSuccess(response) {
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('formLoader').style.display = 'none';
            if (response.status === "sukses") {
                document.getElementById('orderIdDisplay').innerText = response.orderId;
                const waMessage = encodeURIComponent("Konfirmasi pembayaran untuk Pesanan " + response.orderId);
                document.getElementById('waLink').href = "https://wa.me/" + NO_WHATSAPP_ADMIN + "?text=" + waMessage;
                showView('tungguView');
            } else {
                alert("Error: " + response.message);
            }
        }

        // --- Logika Admin ---
        document.getElementById('adminLoginForm').addEventListener('submit', function(e){
            e.preventDefault();
            const password = document.getElementById('password').value;
            google.script.run.withSuccessHandler(onLoginSuccess).withFailureHandler(onFailure).checkAdminLogin(password);
        });
        function onLoginSuccess(response){
            if(response.success){
                document.getElementById('password').value = ''; // Kosongkan password setelah login
                showView('adminDashboardView');
                loadOrders();
            } else {
                alert('Password salah!');
            }
        }
        function loadOrders() {
            document.getElementById('dashboardLoader').style.display = 'block';
            google.script.run.withSuccessHandler(displayOrders).withFailureHandler(onFailure).getPendingOrders();
        }
        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Tidak ada pesanan yang menunggu.</td></tr>';
            } else {
                orders.reverse().forEach(order => {
                    const row = tbody.insertRow();
                    row.innerHTML = `<td>${order.timestamp}</td><td>${order.orderId}</td><td>${order.dewasa}</td><td>${order.anak}</td><td>${order.total.toLocaleString('id-ID')}</td><td><button class="confirm-btn" data-orderid="${order.orderId}">Konfirmasi</button></td>`;
                });
            }
            document.getElementById('dashboardLoader').style.display = 'none';
        }
        document.getElementById('ordersTableBody').addEventListener('click', function(e){
            if(e.target && e.target.classList.contains('confirm-btn')){
                const orderId = e.target.dataset.orderid;
                if(confirm('Konfirmasi pembayaran untuk pesanan ' + orderId + '?')){
                    e.target.disabled = true;
                    e.target.innerText = "OK...";
                    google.script.run.withSuccessHandler(onConfirmSuccess).withFailureHandler(onFailure).confirmPayment(orderId);
                }
            }
        });
        function onConfirmSuccess(response){
            alert(response.message);
            if(response.success){
                loadOrders();
            }
        }
        
        // --- Penanganan Error Universal ---
        function onFailure(error) {
            alert('Terjadi kesalahan: ' + error.message);
            // Sembunyikan semua loader
            document.querySelectorAll('.loader').forEach(l => l.style.display = 'none');
            document.getElementById('submitBtn').style.display = 'block';
        }
    </script>
</body>
</html>
